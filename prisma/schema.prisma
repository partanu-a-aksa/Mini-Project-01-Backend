generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ATTENDEE
  ORGANIZER
}

enum TransactionStatus {
  WAITING_FOR_PAYMENT
  WAITING_FOR_ADMIN_CONFIRMATION
  DONE
  REJECTED
  EXPIRED
  CANCELED
}

enum PointSource {
  REFERRAL
  REFUND
  REDEEM
}

enum EventCategory {
  FESTIVAL
  MUSIC
  ART
  EDUCATION
}

model User {
  id             String  @id @default(uuid())
  fullName       String
  email          String  @unique
  password       String
  role           Role
  referralCode   String? @unique
  profilePicture String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events               Event[]
  transactions         Transaction[]
  referralLogsSent     ReferralLog[] @relation("SentReferrals")
  referralLogsReceived ReferralLog[] @relation("ReceivedReferrals")
  coupons              Coupon[]
  points               Point[]
}

model ReferralLog {
  id             Int      @id @default(autoincrement())
  referredBy     User     @relation("SentReferrals", fields: [referredById], references: [id])
  referredById   String
  referralUsed   User     @relation("ReceivedReferrals", fields: [referralUsedId], references: [id])
  referralUsedId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt
}

model Event {
  id             Int           @id @default(autoincrement())
  organizer      User          @relation(fields: [organizerId], references: [id])
  organizerId    String
  name           String
  description    String
  category       EventCategory
  location       String
  paid           Boolean
  price          Int
  startDate      DateTime
  endDate        DateTime
  totalSeats     Int
  remainingSeats Int
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now()) @updatedAt

  vouchers     Voucher[]
  transactions Transaction[]
  reviews      Review[]
}

model Voucher {
  id             Int      @id @default(autoincrement())
  event          Event    @relation(fields: [eventId], references: [id])
  eventId        Int
  code           String   @unique
  discountAmount Int
  discountType   String
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean  @default(true)
  updatedAt      DateTime @default(now()) @updatedAt

  transactions Transaction[]
}

model Transaction {
  id             Int               @id @default(autoincrement())
  user           User              @relation(fields: [userId], references: [id])
  userId         String
  event          Event             @relation(fields: [eventId], references: [id])
  eventId        Int
  ticketQuantity Int
  price          Int
  totalPrice     Int
  status         TransactionStatus @default(WAITING_FOR_PAYMENT)
  paymentProof   String?
  usedPoint      Int               @default(0)
  usedVoucher    Voucher?          @relation(fields: [usedVoucherId], references: [id])
  usedVoucherId  Int?
  usedCoupon     Coupon?           @relation(fields: [usedCouponId], references: [id])
  usedCouponId   Int?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @default(now()) @updatedAt

  review Review?
}

model Coupon {
  id             Int      @id @default(autoincrement())
  user           User     @relation(fields: [userId], references: [id])
  userId         String
  code           String   @unique
  discountAmount Int
  expiredAt      DateTime
  isUsed         Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  transactions Transaction[]
}

model Point {
  id        Int         @id @default(autoincrement())
  user      User        @relation(fields: [userId], references: [id])
  userId    String
  amount    Int
  source    PointSource
  expiredAt DateTime
  isExpired Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @default(now()) @updatedAt
}

model Review {
  id            Int         @id @default(autoincrement())
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  transactionId Int         @unique
  event         Event       @relation(fields: [eventId], references: [id])
  eventId       Int
  rating        Int
  comment       String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @default(now()) @updatedAt
}
